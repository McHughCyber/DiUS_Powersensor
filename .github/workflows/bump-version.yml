name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  bump_version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: "3.12"

      - name: Get Current Version
        id: current
        run: |
          CURRENT=$(python3 -c "import json; print(json.load(open('custom_components/dius/manifest.json'))['version'])")
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          IFS='.' read -ra ADDR <<< "$CURRENT"
          echo "major=${ADDR[0]}" >> $GITHUB_OUTPUT
          echo "minor=${ADDR[1]}" >> $GITHUB_OUTPUT
          echo "patch=${ADDR[2]}" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Calculate New Version
        id: new_version
        run: |
          MAJOR=${{ steps.current.outputs.major }}
          MINOR=${{ steps.current.outputs.minor }}
          PATCH=${{ steps.current.outputs.patch }}
          
          case "${{ github.event.inputs.version_type }}" in
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
              ;;
            minor)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              ;;
            patch)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              ;;
          esac
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update Manifest
        run: |
          python3 manage/update_manifest.py --version ${{ steps.new_version.outputs.new_version }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bump-version/${{ steps.new_version.outputs.new_version }}
          commit-message: "chore: bump version to ${{ steps.new_version.outputs.new_version }}"
          title: "Bump version to ${{ steps.new_version.outputs.new_version }}"
          body: |
            Automated version bump: ${{ steps.current.outputs.current_version }} â†’ ${{ steps.new_version.outputs.new_version }}
            
            **Version Type:** ${{ github.event.inputs.version_type }}
            
            **Changes:**
            - Updated `custom_components/dius/manifest.json` version to ${{ steps.new_version.outputs.new_version }}
            
            Please review and merge this PR to update the version. After merging, you can create a release with the tag `v${{ steps.new_version.outputs.new_version }}`.
          labels: |
            ci
            dependencies

